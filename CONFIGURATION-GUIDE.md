# ğŸ”§ Complete Configuration Guide

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WordPress Plugin                         â”‚
â”‚  (Thin Client - Installed on User's WordPress Site)         â”‚
â”‚                                                             â”‚
â”‚  User's WordPress Site: example.com                        â”‚
â”‚  - Plugin sends queries to API                             â”‚
â”‚  - Receives responses                                      â”‚
â”‚  - Stores chat history locally                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ HTTPS API Call
                       â”‚ Authorization: Bearer {API_KEY}
                       â”‚ Body: { question, site, context }
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              HeyTrisha API Server                          â”‚
â”‚         (api.heytrisha.com)                                â”‚
â”‚                                                             â”‚
â”‚  - Validates API key                                       â”‚
â”‚  - Processes NLP queries                                   â”‚
â”‚  - Generates SQL/API requests                              â”‚
â”‚  - Calls back to user's WordPress site                     â”‚
â”‚  - Returns formatted responses                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ WordPress REST API Call
                       â”‚ (Back to user's site)
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            User's WordPress Site                            â”‚
â”‚  (example.com - Same site as plugin)                       â”‚
â”‚                                                             â”‚
â”‚  - Receives API requests from HeyTrisha server              â”‚
â”‚  - Executes queries/actions                                â”‚
â”‚  - Returns data                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Authentication & Multi-User Architecture

### How Multiple Users Are Handled

Each WordPress installation gets its own **unique API key**. This ensures:

1. **User Isolation**: Each WordPress site's queries are isolated
2. **Security**: API keys authenticate which site is making requests
3. **Billing**: Track usage per API key
4. **Data Privacy**: Site URL identifies which WordPress site to call back

### Communication Flow

```
User Query â†’ WordPress Plugin â†’ API Server â†’ WordPress Site â†’ Response
```

1. **User types query** in WordPress admin
2. **Plugin sends** to `api.heytrisha.com/api/query` with:
   - `Authorization: Bearer {USER_API_KEY}`
   - `question`: User's query
   - `site`: WordPress site URL (e.g., `https://example.com`)
   - `context`: `woocommerce`
3. **API Server validates** API key and processes query
4. **API Server calls back** to user's WordPress site (using site URL)
5. **WordPress site** executes query and returns data
6. **API Server** formats response and sends back to plugin
7. **Plugin displays** response to user

---

## ğŸ“‹ Part 1: API Server Configuration (api.heytrisha.com)

### Step 1: Deploy Laravel API Server

1. **Upload API server** to your hosting:
   ```bash
   # Extract heytrisha-api-server-v1.0-*.zip
   # Upload to: /var/www/api.heytrisha.com/
   ```

2. **Install dependencies**:
   ```bash
   cd /var/www/api.heytrisha.com/
   composer install --no-dev --optimize-autoloader
   ```

3. **Configure environment**:
   ```bash
   cp .env.example .env
   php artisan key:generate
   ```

### Step 2: Configure `.env` File

```env
APP_NAME="HeyTrisha API"
APP_ENV=production
APP_KEY=base64:... (generated by artisan)
APP_DEBUG=false
APP_URL=https://api.heytrisha.com

# Database (for storing API keys, usage logs, etc.)
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=heytrisha_api
DB_USERNAME=your_db_user
DB_PASSWORD=your_db_password

# OpenAI Configuration
OPENAI_API_KEY=sk-your-openai-api-key

# CORS - Allow WordPress sites
CORS_ALLOWED_ORIGINS=https://example.com,https://another-site.com

# Rate Limiting
RATE_LIMIT_PER_MINUTE=60
```

### Step 3: Set Up API Key Management

Create a database table to store API keys:

```sql
CREATE TABLE api_keys (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    api_key VARCHAR(255) UNIQUE NOT NULL,
    site_url VARCHAR(255) NOT NULL,
    user_email VARCHAR(255),
    status ENUM('active', 'suspended', 'expired') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_api_key (api_key),
    INDEX idx_site_url (site_url)
);
```

### Step 4: Create API Key Endpoint

Create `app/Http/Controllers/ApiKeyController.php`:

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\DB;

class ApiKeyController extends Controller
{
    public function generate(Request $request)
    {
        $request->validate([
            'site_url' => 'required|url',
            'user_email' => 'required|email'
        ]);

        $apiKey = 'ht_' . Str::random(48);

        DB::table('api_keys')->insert([
            'api_key' => $apiKey,
            'site_url' => $request->site_url,
            'user_email' => $request->user_email,
            'status' => 'active',
            'created_at' => now(),
            'updated_at' => now()
        ]);

        return response()->json([
            'success' => true,
            'api_key' => $apiKey,
            'message' => 'API key generated successfully'
        ]);
    }
}
```

### Step 5: Add API Key Middleware

Create `app/Http/Middleware/ValidateApiKey.php`:

```php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;

class ValidateApiKey
{
    public function handle(Request $request, Closure $next)
    {
        $apiKey = $request->bearerToken();

        if (!$apiKey) {
            return response()->json([
                'success' => false,
                'message' => 'API key is required'
            ], 401);
        }

        // Remove 'Bearer ' prefix if present
        $apiKey = str_replace('Bearer ', '', $apiKey);

        $keyRecord = DB::table('api_keys')
            ->where('api_key', $apiKey)
            ->where('status', 'active')
            ->first();

        if (!$keyRecord) {
            return response()->json([
                'success' => false,
                'message' => 'Invalid or inactive API key'
            ], 401);
        }

        // Add site info to request for use in controllers
        $request->merge([
            'site_url' => $keyRecord->site_url,
            'user_email' => $keyRecord->user_email
        ]);

        return $next($request);
    }
}
```

### Step 6: Update Routes

In `routes/api.php`:

```php
use App\Http\Controllers\ApiKeyController;
use App\Http\Controllers\NLPController;
use App\Http\Middleware\ValidateApiKey;

// Public route for generating API keys (protect with admin auth)
Route::post('/api-keys/generate', [ApiKeyController::class, 'generate']);

// Protected routes - require API key
Route::middleware([ValidateApiKey::class])->group(function () {
    Route::post('/api/query', [NLPController::class, 'query']);
    Route::get('/api/health', function() {
        return response()->json(['status' => 'ok']);
    });
});
```

### Step 7: Update NLP Controller

In `app/Http/Controllers/NLPController.php`, use the site URL from request:

```php
public function query(Request $request)
{
    // Site URL is already added by ValidateApiKey middleware
    $siteUrl = $request->input('site_url'); // From middleware
    $question = $request->input('question');
    $context = $request->input('context', 'woocommerce');

    // Use $siteUrl to call back to user's WordPress site
    // Process query and return response
}
```

---

## ğŸ“‹ Part 2: WordPress Plugin Configuration (User Side)

### Step 1: User Gets API Key

**Option A: User registers on your website**

1. User visits `https://heytrisha.com/signup`
2. Enters WordPress site URL: `https://example.com`
3. Enters email address
4. Receives API key: `ht_abc123xyz...`

**Option B: Admin generates API key**

1. Admin generates API key via API endpoint
2. Sends API key to user via email
3. User copies API key

### Step 2: User Installs Plugin

1. **Download plugin**: `heytrisha-woo-plugin-v1.0-*.zip`
2. **Install in WordPress**:
   - Plugins â†’ Add New â†’ Upload Plugin
   - Select ZIP file
   - Activate plugin

### Step 3: User Configures Plugin

1. **Go to Settings**:
   - WordPress Admin â†’ Hey Trisha â†’ Settings

2. **Enter API Configuration**:
   ```
   API URL: https://api.heytrisha.com
   API Key: ht_abc123xyz... (from Step 1)
   ```

3. **Click "Save Changes"**

### Step 4: Plugin Sends Test Request

When user sends first query, plugin will:
1. Send to: `https://api.heytrisha.com/api/query`
2. Headers:
   ```
   Authorization: Bearer ht_abc123xyz...
   Content-Type: application/json
   ```
3. Body:
   ```json
   {
     "question": "Show me all orders",
     "site": "https://example.com",
     "context": "woocommerce"
   }
   ```

---

## ğŸ”„ Complete Communication Flow Example

### Example: User asks "Show me all orders"

**Step 1: User â†’ WordPress Plugin**
```
User types: "Show me all orders"
Plugin JavaScript sends to: /wp-admin/admin-ajax.php?action=heytrisha_query
```

**Step 2: WordPress Plugin â†’ API Server**
```http
POST https://api.heytrisha.com/api/query
Authorization: Bearer ht_abc123xyz...
Content-Type: application/json

{
  "question": "Show me all orders",
  "site": "https://example.com",
  "context": "woocommerce"
}
```

**Step 3: API Server Validates**
```php
// ValidateApiKey middleware checks:
- API key exists in database
- API key is active
- Site URL matches: https://example.com
```

**Step 4: API Server Processes Query**
```php
// NLPController processes:
- Uses OpenAI to understand query
- Generates WooCommerce API request
- Determines endpoint: /wp-json/wc/v3/orders
```

**Step 5: API Server â†’ User's WordPress Site**
```http
GET https://example.com/wp-json/wc/v3/orders
Authorization: Basic {wordpress_credentials}
```

**Step 6: WordPress Site â†’ API Server**
```json
[
  {
    "id": 123,
    "status": "completed",
    "total": "99.00",
    ...
  }
]
```

**Step 7: API Server â†’ WordPress Plugin**
```json
{
  "success": true,
  "message": "Found 5 orders",
  "data": [
    {
      "id": 123,
      "status": "completed",
      "total": "99.00"
    }
  ]
}
```

**Step 8: WordPress Plugin â†’ User**
```
Displays formatted response in chat interface
```

---

## ğŸ”’ Security Considerations

### API Key Security

1. **API keys are unique per WordPress site**
2. **API keys authenticate requests**
3. **Site URL ensures correct callback**
4. **Rate limiting prevents abuse**

### WordPress Site Security

The API server needs to call back to WordPress sites. Options:

**Option 1: Application Passwords (Recommended)**
- User generates Application Password in WordPress
- Stores in plugin settings (encrypted)
- API server uses for authentication

**Option 2: OAuth 2.0**
- More complex but more secure
- Better for enterprise

**Option 3: Shared Secret Token**
- Simple token-based auth
- Less secure but easier

### Current Implementation

The plugin currently expects WordPress credentials to be stored. For the external API model, you have two options:

**Option A: Store WordPress credentials in API server**
- User provides WordPress credentials during API key generation
- API server stores them encrypted
- API server uses them to call back

**Option B: User provides credentials in plugin**
- User enters WordPress credentials in plugin settings
- Plugin sends them to API server with each request
- API server uses them for callback

---

## ğŸ“Š Multi-User Data Isolation

### How It Works

1. **API Key = User Identity**
   - Each WordPress site has unique API key
   - API key maps to site URL
   - All queries tagged with API key

2. **Site URL = Callback Target**
   - API server uses site URL to call back
   - Ensures queries go to correct WordPress site
   - Prevents cross-site data leakage

3. **Database Isolation**
   - API server can store per-key usage logs
   - Each key's data is separate
   - Billing tracked per key

### Example: Two Users

**User A (example.com)**
- API Key: `ht_key123`
- Site URL: `https://example.com`
- Queries tagged with `ht_key123`
- Callbacks go to `https://example.com`

**User B (another-site.com)**
- API Key: `ht_key456`
- Site URL: `https://another-site.com`
- Queries tagged with `ht_key456`
- Callbacks go to `https://another-site.com`

**No data mixing** - Each user's queries are completely isolated.

---

## ğŸš€ Quick Setup Checklist

### For API Server Admin (You)

- [ ] Deploy Laravel API server to `api.heytrisha.com`
- [ ] Configure `.env` file
- [ ] Create `api_keys` database table
- [ ] Implement `ValidateApiKey` middleware
- [ ] Set up API key generation endpoint
- [ ] Configure OpenAI API key
- [ ] Test API endpoint: `POST /api/query`

### For WordPress Users

- [ ] Sign up at `heytrisha.com` to get API key
- [ ] Install WordPress plugin
- [ ] Configure API URL: `https://api.heytrisha.com`
- [ ] Enter API key from signup
- [ ] (Optional) Configure WordPress credentials for callbacks
- [ ] Test by sending a query

---

## ğŸ§ª Testing

### Test API Server

```bash
# Test health endpoint
curl https://api.heytrisha.com/api/health

# Test query endpoint
curl -X POST https://api.heytrisha.com/api/query \
  -H "Authorization: Bearer ht_test_key_123" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "Show me all products",
    "site": "https://example.com",
    "context": "woocommerce"
  }'
```

### Test WordPress Plugin

1. Install plugin
2. Configure API URL and key
3. Open chat interface
4. Send test query: "Show me all products"
5. Verify response appears

---

## ğŸ“ Support

If users have issues:

1. **Check API key is valid** - Verify in database
2. **Check site URL matches** - Must match WordPress site URL
3. **Check API server logs** - Laravel logs show errors
4. **Check WordPress credentials** - If using callbacks
5. **Check network connectivity** - Plugin must reach API server

---

## ğŸ”„ Updating Configuration

### User Changes WordPress Site URL

1. User updates site URL in WordPress settings
2. User must update API key registration
3. Or admin updates `api_keys` table with new site URL

### User Needs New API Key

1. Generate new API key via API endpoint
2. User updates plugin settings with new key
3. Old key can be deactivated in database

---

This architecture ensures:
âœ… **Security** - Each user isolated by API key
âœ… **Scalability** - API server handles all processing
âœ… **Simplicity** - Users only configure API key
âœ… **Privacy** - Each site's data stays separate


